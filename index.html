<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cow Says Moo!</title>

    <!-- Bootstrap -->
    <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <br><br>
    <div class="row">
        <div class="col-md-8 col-md-offset-2">
            <div id="notconnected">
<!--                 <input type="text" value="54.86.130.230" name="server" /> -->
                <input type="text" value="localhost" name="server" />
                <input type="text" value="7777" name="port" /> 
                <button id="connect-button">Connect!</button>
            </div>
            <div id="connected">
                <div class="well">
                    <div id="the-log">
                        yahoo!
                    </div>
                    <div id="the-input">
                        <input type="text" placeholder="type here..." name="the-input" size="80"/>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="/static/js/jquery-2.0.3.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript">
     

var done = false;

function add_to_log(the_string) {
    $("#the-log").html($('#the-log').html() + the_string);
    $("#the-log").prop({ scrollTop: $("#the-log").prop("scrollHeight") });
}

function clear_log() {
    $("#the-log").html('');
    $("#the-log").prop({ scrollTop: $("#the-log").prop("scrollHeight") });
}

function quit_it() {
    done = true;
    clear_log();
    $('#notconnected').show();
    $('#connected').hide();    
}

function update_log() {
    if (done == true) {
        return;
    } else {
        $.ajax({
            type: "GET",
            url: "/log",
            async: true,
            success: function(string) {
                if (string != '') {
                    if (string == '%%%') {
                        quit_it();
                    } else {
                        add_to_log(string);
                    }
                }
            }
        });
        window.setTimeout (update_log, 200);
    }
}

$(document).ready(function() {

     $("#connect-button").click(function(e) {
        $.post("/connect", {"server": $("input[name='server']").val(), "port": $("input[name='port']").val()})
        .done(function(string) {
            clear_log();
           $("#notconnected").hide();
           $("#connected").show();
            done = false;
           window.setTimeout( update_log, 20 );
        });
       e.preventDefault();
     });

     $("#the-input").keypress(function(e) {
        if (e.which == 13) {
            the_input_string = $("input[name='the-input']").val();
           $.ajax({
              type: "PUT",
              url: "/input",
              data: {"input_string": the_input_string}
           })
           .done(function() {
                add_to_log(">"+the_input_string+'<br>');
                $("#the-input input").val('');
           });
           e.preventDefault();
        }
     });

    $(window).bind("beforeunload", function(eventObject) {
        done=true;
        $.ajax({
          type: "PUT",
          url: "/kill"
        });
    })

    $('#notconnected').show();
    $('#connected').hide();
});
 </script>
  </body>
</html>
